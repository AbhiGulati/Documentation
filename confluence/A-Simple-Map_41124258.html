<!DOCTYPE html>
<html>
    <head>
        <title>Certora Prover Documentation : A Simple Map</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">Certora Prover Documentation</a></span>
                            </li>
                                                    <li>
                                <span><a href="Certora-Prover-Documentation_2916669.html">Certora Prover Documentation</a></span>
                            </li>
                                                    <li>
                                <span><a href="Specification-By-Example_5243036.html">Specification By Example</a></span>
                            </li>
                                                    <li>
                                <span><a href="41255215.html">The (Iterable) Map</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            Certora Prover Documentation : A Simple Map
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> Shelly</span>, last modified on May 22, 2021
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <h3 id="ASimpleMap-TheSimpleMapcontract">The SimpleMap contract</h3><h4 id="ASimpleMap-Thecode">The code</h4><p>The below code contains the implementation of a simple map data structure, holding <code>uint</code> keys, <code>uint</code> values, and assuming that the value <code>0</code> indicates a non-existent key. It is possible to get, insert, or remove a key from the map.</p><div class="ap-container" id="ap-confluence-prism__confluence-prism-macro6517336344378100877">

  <div class="ap-content " id="embedded-confluence-prism__confluence-prism-macro6517336344378100877"></div>
  <script class="ap-iframe-body-script">
  (function(){
    var data = {
    "addon_key":"confluence-prism",
    "uniqueKey":"confluence-prism__confluence-prism-macro6517336344378100877",
    "key":"confluence-prism-macro",
     "moduleType":"dynamicContentMacros",      "moduleLocation":"content",         "cp":"/wiki",
            "general":"",
    "w":"100%",
    "h":"360px",
    "url":"https://confluence-prism.weweave.net/macro?pageId=41124258&pageVersion=2&macroId=927e388f-5564-4f19-8c1c-55a3d0f3c109&outputType=html_export&language=Solidity+%28Ethereum%29&height=&limitHeight=&lineNumbers=true&lineNumbersStart=&lineHighlight=&downloadFilename=&dialogTitle=&xdm_e=https%3A%2F%2Fcertora.atlassian.net&xdm_c=channel-confluence-prism__confluence-prism-macro6517336344378100877&cp=%2Fwiki&xdm_deprecated_addon_key_do_not_use=confluence-prism&lic=active&cv=1.1192.0&jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiI2MGZjMjVkNzhiMWE5YjAwNmYxNmFiZDAiLCJxc2giOiIwOWRmY2NmMThkM2E5MDI1NGNhYmY1YWMwYTNjOTMwN2FiOTRmODI0MGNlYjc0MDhjODM4NGZhNTZmZWUzMjU3IiwiaXNzIjoiZjA3Y2YyNDYtOTk1OS0zNzJlLWFlMzQtM2Y1ZmE5Njc3OTdhIiwiY29udGV4dCI6e30sImV4cCI6MTY0Mjc3NzQyMCwiaWF0IjoxNjQyNzc3MjQwfQ.zVCDGajw-W60pvWyx5KIDVYgBR98zxYvzTV_j6q9u9c",
     "contextJwt": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiI2MGZjMjVkNzhiMWE5YjAwNmYxNmFiZDAiLCJxc2giOiJjb250ZXh0LXFzaCIsImlzcyI6ImYwN2NmMjQ2LTk5NTktMzcyZS1hZTM0LTNmNWZhOTY3Nzk3YSIsImNvbnRleHQiOnsibGljZW5zZSI6eyJhY3RpdmUiOnRydWV9LCJjb25mbHVlbmNlIjp7ImVkaXRvciI6eyJ2ZXJzaW9uIjoiXCJ2MlwiIn0sIm1hY3JvIjp7Im91dHB1dFR5cGUiOiJodG1sX2V4cG9ydCIsImhhc2giOiI5MjdlMzg4Zi01NTY0LTRmMTktOGMxYy01NWEzZDBmM2MxMDkiLCJpZCI6IjkyN2UzODhmLTU1NjQtNGYxOS04YzFjLTU1YTNkMGYzYzEwOSJ9LCJjb250ZW50Ijp7InR5cGUiOiJwYWdlIiwidmVyc2lvbiI6IjIiLCJpZCI6IjQxMTI0MjU4In0sInNwYWNlIjp7ImtleSI6IkNQRCIsImlkIjoiMjkxNjUyNSJ9fX0sImV4cCI6MTY0Mjc3ODE0MCwiaWF0IjoxNjQyNzc3MjQwfQ.E5t8VERXhwgfu0Vl_STsPg4AmDI9RFoVTXzNNWQqg-4",    "structuredContext": "{\"license\":{\"active\":true},\"confluence\":{\"editor\":{\"version\":\"\\\"v2\\\"\"},\"macro\":{\"outputType\":\"html_export\",\"hash\":\"927e388f-5564-4f19-8c1c-55a3d0f3c109\",\"id\":\"927e388f-5564-4f19-8c1c-55a3d0f3c109\"},\"content\":{\"type\":\"page\",\"version\":\"2\",\"id\":\"41124258\"},\"space\":{\"key\":\"CPD\",\"id\":\"2916525\"}}}",
    "contentClassifier":"content",
    "productCtx":"{\"page.id\":\"41124258\",\"macro.hash\":\"927e388f-5564-4f19-8c1c-55a3d0f3c109\",\"lineNumbers\":\"true\",\"space.key\":\"CPD\",\"user.id\":\"60fc25d78b1a9b006f16abd0\",\"page.type\":\"page\",\"content.version\":\"2\",\"page.title\":\"A Simple Map\",\"macro.localId\":\"\",\"language\":\"Solidity (Ethereum)\",\"macro.body\":\"pragma solidity ^0.7.0;\\n\\ncontract SimpleMap {\\n    mapping(uint =\u003e uint) internal map;\\n    function get(uint key) public view ret\",\": = | RAW | = :\":\"lineNumbers=true|language=Solidity (Ethereum)\",\"space.id\":\"2916525\",\"macro.truncated\":\"true\",\"content.type\":\"page\",\"output.type\":\"html_export\",\"page.version\":\"2\",\"user.key\":\"8a7f808a7ad469f9017ad8f4037a0390\",\"content.id\":\"41124258\",\"macro.id\":\"927e388f-5564-4f19-8c1c-55a3d0f3c109\",\"editor.version\":\"\\\"v2\\\"\"}",
    "timeZone":"US/Eastern",
    "origin":"https://confluence-prism.weweave.net",
    "hostOrigin":"https://certora.atlassian.net",
    "sandbox":"allow-downloads allow-forms allow-modals allow-popups allow-scripts allow-same-origin allow-top-navigation-by-user-activation allow-storage-access-by-user-activation",            "apiMigrations": {
        "gdpr": true
    }
}
;
    if(window.AP && window.AP.subCreate) {
      window._AP.appendConnectAddon(data);
    } else {
      require(['ac/create'], function(create){
        create.appendConnectAddon(data);
      });
    }
  }());
</script>
</div>
<p>In the next sections of the tutorial, we will generalize this trivial contract to support enumeration of the keys in the map.</p><h3 id="ASimpleMap-Writingspecs">Writing specs</h3><p>Writing rules requires us to consider what are the high-level properties our contract should satisfy. We show some simple and useful patterns for rules.</p><h4 id="ASimpleMap-Generalizedunittests">Generalized unit tests</h4><p>Rules that generalize unit tests focus on a single state-mutating function of the contract and ensure that the state is mutated as expected. The main benefits of these rules are that they are easy to develop due to their similarity to unit tests. The added advantage compared to unit tests is that they only use symbolic values, meaning that we check not a single set of concrete values in the unit test but <em>all</em> possible values.</p><p>Here is a simple rule for the <code>insert</code> function:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">rule checkInsert(uint key, uint value) {
    env e;
    insert(e, key, value);
    assert get(key) == value, &quot;value of key is not equal to the inserted value&quot;;
    assert contains(key), &quot;key is not contained after successful insertion&quot;;
}
</pre>
</div></div><p>This rule checks that once a key is successfully inserted with <code>insert</code>, getting the key with <code>get</code> returns the value inserted. The <code>key</code> and <code>value</code> parameters declared in the rule's header are completely arbitrarily chosen. The <code>env</code> (environment) variable <code>e</code> is capturing the (symbolic) values of the blockchain variables, such as <code>msg.sender</code> and <code>block.number</code>. The invocation of insert expects to get as a first argument the environment variable, followed by the arguments according to the function's declaration.</p><div class="confluence-information-macro confluence-information-macro-information"><span class="aui-icon aui-icon-small aui-iconfont-info confluence-information-macro-icon"></span><div class="confluence-information-macro-body"><p>Note that by default, the invocation of a function is assumed to succeed. That is, reverting paths of the function are ignored.</p></div></div><p>After calling <code>insert</code>, we wish to examine if the mutated state is as expected. Therefore, we assert that calling <code>get(key)</code> is returning the value <code>value</code> inserted. It is possible to add an explanation string to the assertion, which may help in finding out which assertion was violated if a rule contains more than one assertion.</p><p>We are now ready to run our the tool: suppose the contract is saved in a file called <code>SimpleMap.sol</code>, and the spec is saved in a file <code>simpleMap.spec</code>, we can run the tool as follows:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">certoraRun SimpleMap.sol --verify SimpleMap:simpleMap.spec</pre>
</div></div><p>Which tells the tool to include the <code>SimpleMap</code> contract in its verification context, and to verify it using the provided spec file.</p><p>Unfortunately, the tool outputs the following error:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">[main] ERROR log.Logger - Syntax error in spec file (9:5): could not type expression &quot;get(key)&quot;, message: Could not find an overloading of method get that matches the given arguments: uint. Method is not envfree; did you forget to provide the environment as the first function argument?</pre>
</div></div><p>The cause of the failure is that we did not pass an environment variable to the invocation of <code>get</code>. While it is possible to reuse <code>e</code> or even declare another environment variable, we note that <code>get</code> does not depend on any of the blockchain-related variables. Thus, we can tell the Prover to relieve us from specifying the environment by adding the following declaration to the top of the spec file:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">methods {
    get(uint) returns uint envfree
}</pre>
</div></div><p>Add an envfree declaration for the method <code>contains</code> too.</p><h4 id="ASimpleMap-Revertconditions">Revert conditions</h4><p>As noted before, by default, invocations are assuming only the non-reverting paths of the function. It is useful to precisely characterize all conditions that guarantee that the function would not revert. We can write such a rule for <code>insert</code>:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">rule insertRevertConditions(uint key, uint value) {
    env e;
    insert@withrevert(e, key, value);
    bool succeeded = !lastReverted;

    assert value != 0  =&gt; succeeded;
}</pre>
</div></div><p>Here, we invoke <code>insert</code> but append to the function name the modifier <code>@withrevert</code> that tells the Prover to skip the pruning of reverting paths. (One could also stress that a function should prune the reverting paths using <code>@norevert</code>, although this is equivalent to not writing any modifier at all.) We then save into a boolean variable the negation of <code>lastReverted</code>, which is a special keyword set to <code>true</code> if the last invocation reverted. We then assert that if the value inserted is non-zero (recall that we consider 0 to be an illegal value in our map implementation), then the value of <code>succeeded</code> must be true.</p><div class="confluence-information-macro confluence-information-macro-information"><span class="aui-icon aui-icon-small aui-iconfont-info confluence-information-macro-icon"></span><div class="confluence-information-macro-body"><p><code>lastReverted</code> will <em>always</em> be <code>false</code> following an invocation that is not permitting reverting paths.</p></div></div><p>Running the Prover on the new rule, it returns a failure. The failure is happening because <code>value</code> is non-zero yet the <code>insert</code> function reverted anyway.</p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="attachments/41124258/41255230.png" data-image-src="attachments/41124258/41255230.png" data-height="674" data-width="910" data-unresolved-comment-count="0" data-linked-resource-id="41255230" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20210522-195556.png" data-base-url="https://certora.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="41124258" data-linked-resource-container-version="2" data-media-id="3a2b642a-8349-45e3-bfe8-2ca450b54239" data-media-type="file"></span><p>A hint towards what happened can be found in the <code>Variables</code> section. The value of <code>e.msg.value</code> is indicating the <code>msg.value</code> used in <code>insert</code>. Since <code>insert</code> is not a payable function, it is expected to revert when <code>msg.value</code> is non-zero, which is indeed our case here.</p><p>We refine the rule as follows, and require that <code>e.msg.value</code> is 0:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">rule insertRevertConditions(uint key, uint value) {
    env e;
    insert@withrevert(e, key, value);
    bool succeeded = !lastReverted;

    assert (e.msg.value == 0 
        &amp;&amp; value != 0)
        =&gt; succeeded;
}
</pre>
</div></div><p>We run the rule again, but it still fails:</p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image image-center" loading="lazy" src="attachments/41124258/41255240.png" data-image-src="attachments/41124258/41255240.png" data-height="846" data-width="2076" data-unresolved-comment-count="0" data-linked-resource-id="41255240" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="image-20210522-195619.png" data-base-url="https://certora.atlassian.net/wiki" data-linked-resource-content-type="image/png" data-linked-resource-container-id="41124258" data-linked-resource-container-version="2" data-media-id="4087bd77-7a3c-496e-9d8b-39cb1dd73d00" data-media-type="file"></span><p>We get a call trace that tells us the most important operations performed by the bytecode of the contract, on which the Prover operates. The call trace tells us that we were reading from a storage slot the value 1. To assist us in identifying the issue, in parenthesis we get a reference to the matching source code, which is the load of <code>map[key]</code> in line 19, which is where the <code>contains</code> function is defined. We understand that we forgot to include the condition that the key does not already exist in the map. So we refine the code again:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">rule insertRevertConditions(uint key, uint value) {
    env e;
    insert@withrevert(e, key, value);
    bool succeeded = !lastReverted;

    assert (e.msg.value == 0 
        &amp;&amp; value != 0
        &amp;&amp; !contains(key))
        =&gt; succeeded;
}</pre>
</div></div><p>And finally our rule is successfully verified.</p><h4 id="ASimpleMap-Inverses">Inverses</h4><p>In some cases, we can reach wider coverage if we write rules that check the interaction of multiple functions with each other. In the map implementation, it is natural to check that insert and remove inverses of one another. Specifically, we'd like to check that:</p><ul><li><p>Invoking <code>remove</code> after a successful <code>insert</code> must succeed too.</p></li><li><p>The value of a key that was inserted and immediately removed is not the value that we inserted.</p></li></ul><p>The below rule shows how we can check these two assertions:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">rule inverses(uint key, uint value) {
    env e;
    insert(e, key, value);
    env e2;
    require e2.msg.value == 0;
    remove@withrevert(e2, key);
    bool removeSucceeded = !lastReverted;
    assert removeSucceeded, &quot;remove after insert must succeed&quot;;
    assert get(key) != value, &quot;value of removed key must not be the inserted value&quot;;
}
</pre>
</div></div><p>Note that we use two separate environments for <code>insert</code> and <code>remove</code> for better coverage.</p><div class="confluence-information-macro confluence-information-macro-information"><span class="aui-icon aui-icon-small aui-iconfont-info confluence-information-macro-icon"></span><div class="confluence-information-macro-body"><p>Reuse of environment variables could lead to vacuity, which is expanded upon in other sections of this manual.</p></div></div><div class="confluence-information-macro confluence-information-macro-information"><span class="aui-icon aui-icon-small aui-iconfont-info confluence-information-macro-icon"></span><div class="confluence-information-macro-body"><p>It is recommended to keep <code>lastReverted</code> in separate variables to clearly indicate which invocation we refer to, and to avoid confusion if invocations are reordered.</p></div></div><p>This rule is verified by the Prover.</p>
                    </div>

                                        <div class="pageSection group">
                        <div class="pageSectionHeader">
                            <h2 id="attachments" class="pageSectionTitle">Attachments:</h2>
                        </div>

                        <div class="greybox" align="left">
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/41124258/41255230.png">image-20210522-195556.png</a> (image/png)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/41124258/41255240.png">image-20210522-195619.png</a> (image/png)
                                <br/>
                                                    </div>
                    </div>
                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Jan 21, 2022 10:00</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
