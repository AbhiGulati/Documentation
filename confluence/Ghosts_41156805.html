<!DOCTYPE html>
<html>
    <head>
        <title>Certora Prover Documentation : Ghosts</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">Certora Prover Documentation</a></span>
                            </li>
                                                    <li>
                                <span><a href="Certora-Prover-Documentation_2916669.html">Certora Prover Documentation</a></span>
                            </li>
                                                    <li>
                                <span><a href="The-Anatomy-of-a-Specification_238845999.html">The Anatomy of a Specification</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            Certora Prover Documentation : Ghosts
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> thomas</span>, last modified by <span class='editor'> Alexander Nutz</span> on Dec 15, 2021
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <h1 id="Ghosts-WhatareGhosts?">What are Ghosts?</h1><p>At their core, ghosts are just <a href="https://certora.atlassian.net/wiki/spaces/CPD/pages/3014665/Ghost+Functions#Uninterpreted-Functions" rel="nofollow">uninterpreted functions</a>. These uninterpreted functions by themselves wouldn't really be &quot;ghosts&quot; per-se. However, along with <strong>axioms</strong> and <strong>hooks</strong>, these uninterpreted functions can be used to model some contract state that isn't explicitly in the contract (hence it is a “ghost” state). In our canonical example, we use ghosts to keep track of the sum of balances in a bank contract.</p><h1 id="Ghosts-ASimpleBankExample">A Simple Bank Example</h1><p>Consider the following <code>Bank</code> contract:</p><div class="ap-container" id="ap-confluence-prism__confluence-prism-macro375058630350791690">

  <div class="ap-content " id="embedded-confluence-prism__confluence-prism-macro375058630350791690"></div>
  <script class="ap-iframe-body-script">
  (function(){
    var data = {
    "addon_key":"confluence-prism",
    "uniqueKey":"confluence-prism__confluence-prism-macro375058630350791690",
    "key":"confluence-prism-macro",
     "moduleType":"dynamicContentMacros",      "moduleLocation":"content",         "cp":"/wiki",
            "general":"",
    "w":"100%",
    "h":"360px",
    "url":"https://confluence-prism.weweave.net/macro?pageId=41156805&pageVersion=4&macroId=d07bb9e2-8375-46bb-b1a6-f82c3993588e&outputType=html_export&language=none&height=&limitHeight=&lineNumbers=&lineNumbersStart=&lineHighlight=&downloadFilename=&dialogTitle=&xdm_e=https%3A%2F%2Fcertora.atlassian.net&xdm_c=channel-confluence-prism__confluence-prism-macro375058630350791690&cp=%2Fwiki&xdm_deprecated_addon_key_do_not_use=confluence-prism&lic=active&cv=1.1192.0&jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiI2MGZjMjVkNzhiMWE5YjAwNmYxNmFiZDAiLCJxc2giOiJmMmY2ZmY5ZTgxYzdjYmE0ZTUxYzk0MjQwMGFjNjQ0MTYyZGU5M2Q4OTI5ZjM0YjJiMzUzODA2MjNmOWZiNDFiIiwiaXNzIjoiZjA3Y2YyNDYtOTk1OS0zNzJlLWFlMzQtM2Y1ZmE5Njc3OTdhIiwiY29udGV4dCI6e30sImV4cCI6MTY0Mjc3NzQyMSwiaWF0IjoxNjQyNzc3MjQxfQ.Y-18ZKlo6UTCH5AO4uxYPUpjUL2Ugwy8A9qwuAAp7UQ",
     "contextJwt": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiI2MGZjMjVkNzhiMWE5YjAwNmYxNmFiZDAiLCJxc2giOiJjb250ZXh0LXFzaCIsImlzcyI6ImYwN2NmMjQ2LTk5NTktMzcyZS1hZTM0LTNmNWZhOTY3Nzk3YSIsImNvbnRleHQiOnsibGljZW5zZSI6eyJhY3RpdmUiOnRydWV9LCJjb25mbHVlbmNlIjp7ImVkaXRvciI6eyJ2ZXJzaW9uIjoiXCJ2MlwiIn0sIm1hY3JvIjp7Im91dHB1dFR5cGUiOiJodG1sX2V4cG9ydCIsImhhc2giOiJkMDdiYjllMi04Mzc1LTQ2YmItYjFhNi1mODJjMzk5MzU4OGUiLCJpZCI6ImQwN2JiOWUyLTgzNzUtNDZiYi1iMWE2LWY4MmMzOTkzNTg4ZSJ9LCJjb250ZW50Ijp7InR5cGUiOiJwYWdlIiwidmVyc2lvbiI6IjQiLCJpZCI6IjQxMTU2ODA1In0sInNwYWNlIjp7ImtleSI6IkNQRCIsImlkIjoiMjkxNjUyNSJ9fX0sImV4cCI6MTY0Mjc3ODE0MSwiaWF0IjoxNjQyNzc3MjQxfQ._b7TfHdBSinrxkclkd0KoMP7W32c1dQDDul-cD9y0x0",    "structuredContext": "{\"license\":{\"active\":true},\"confluence\":{\"editor\":{\"version\":\"\\\"v2\\\"\"},\"macro\":{\"outputType\":\"html_export\",\"hash\":\"d07bb9e2-8375-46bb-b1a6-f82c3993588e\",\"id\":\"d07bb9e2-8375-46bb-b1a6-f82c3993588e\"},\"content\":{\"type\":\"page\",\"version\":\"4\",\"id\":\"41156805\"},\"space\":{\"key\":\"CPD\",\"id\":\"2916525\"}}}",
    "contentClassifier":"content",
    "productCtx":"{\"page.id\":\"41156805\",\"macro.hash\":\"d07bb9e2-8375-46bb-b1a6-f82c3993588e\",\"space.key\":\"CPD\",\"user.id\":\"60fc25d78b1a9b006f16abd0\",\"page.type\":\"page\",\"content.version\":\"4\",\"page.title\":\"Ghosts\",\"macro.localId\":\"90afeac2-7300-4d3a-9553-8e22959d9a18\",\"language\":\"none\",\"macro.body\":\"contract Bank {\\n  mapping (address =\u003e uint256) balances;\\n  uint256 public totalSupply;\\n  \\n  function deposit(address a, uint256 \",\": = | RAW | = :\":\"language=none\",\"space.id\":\"2916525\",\"macro.truncated\":\"true\",\"content.type\":\"page\",\"output.type\":\"html_export\",\"page.version\":\"4\",\"user.key\":\"8a7f808a7ad469f9017ad8f4037a0390\",\"content.id\":\"41156805\",\"macro.id\":\"d07bb9e2-8375-46bb-b1a6-f82c3993588e\",\"editor.version\":\"\\\"v2\\\"\"}",
    "timeZone":"US/Eastern",
    "origin":"https://confluence-prism.weweave.net",
    "hostOrigin":"https://certora.atlassian.net",
    "sandbox":"allow-downloads allow-forms allow-modals allow-popups allow-scripts allow-same-origin allow-top-navigation-by-user-activation allow-storage-access-by-user-activation",            "apiMigrations": {
        "gdpr": true
    }
}
;
    if(window.AP && window.AP.subCreate) {
      window._AP.appendConnectAddon(data);
    } else {
      require(['ac/create'], function(create){
        create.appendConnectAddon(data);
      });
    }
  }());
</script>
</div>
<p>‌The state of the contract consists of <code>totalSupply</code> and <code>balances</code> where <code>balances</code> keeps track of the balance in each account and <code>totalSupply</code> keeps track of the sum of all balances. Now let's suppose that we don't trust that <code>totalSupply</code>gets updated correctly. We can introduce a ghost function to keep track of the sum and then compare that ghost function with <code>totalSupply</code> to see if they both got updated as expected. Here's what that looks like:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">// declare the ghost function
ghost ghostSupply() returns uint256;
// the hook that updates the ghost function as follows
// &quot;At every write to the value at key &#39;a&#39; in &#39;balances&#39;
// increase ghostTotalSupply by the difference between
// tho old value and the new value&quot;
//                              the new value ↓ written:
hook Sstore balances[KEY address a] uint256 balance
// the old value ↓ already there
    (uint256 old_balance) STORAGE {
  havoc ghostSupply assuming ghostSupply@new() == ghostSupply@old() +
      (balance - old_balance);
}

rule totalSupplyInvariant(method f) {
  require totalSupply() == ghostSupply();
  calldataarg arg;
  env e;
  sinvoke f(e, arg);
  assert totalSupply() == ghostSupply();
}</pre>
</div></div><p>There are a few things going on here. ‌</p><ol><li><p>We declared <code>ghost ghostSupply() returns uint256</code>. This creates an uninterpreted function called <code>ghostSupply</code>that takes 0 arguments and returns a <code>uint256</code>. Notice that this is in a global scope. Each rule will get its own version of this uninterpreted function, but this way, it doesn't have to be written several times.</p></li><li><p>We declared a <code>hook</code>. This hook tells the tool to analyze the rule and find every <code>Sstore</code> (write) to an entry in <code>balances</code>. It binds the <em>stored value</em> to the name <code>balance</code> and the <em>old value</em> to the name <code>old_balance</code>.</p></li><li><p>We defined a <em>ghost update</em> inside the <em>body</em> of the hook. We used a <code>havoc assuming</code> statement to mutate the ghost function. The <code>havoc assuming</code> statement --- in this case <code>havoc ghostSupply assuming</code> binds <code>ghostSupply@new()</code>, the havoc'd version, and <code>ghostSupply@old()</code> the pre-havoc version. <code>ghostSupply</code> does not exist to the right of <code>assuming</code>. We then constrain the new version in terms of the old.</p></li></ol><p>When all of these work in conjunction, CVT successfully proves the rule <code>totalSupplyInvariant</code>.</p>
                    </div>

                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Jan 21, 2022 10:00</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
