<!DOCTYPE html>
<html>
    <head>
        <title>Certora Prover Documentation : Writing Simple Rules</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">Certora Prover Documentation</a></span>
                            </li>
                                                    <li>
                                <span><a href="Certora-Prover-Documentation_2916669.html">Certora Prover Documentation</a></span>
                            </li>
                                                    <li>
                                <span><a href="Exercises_41255285.html">Exercises</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            Certora Prover Documentation : Writing Simple Rules
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> Shelly</span> on May 22, 2021
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <p>In this exercise we use as an example a straightforward simple bank implementation (<a href="https://github.com/Certora/CertoraProverSupplementary/blob/master/Tutorials/Lesson1/Bank.sol" class="external-link" rel="nofollow">Bank.sol</a>). The contract has a mapping from users to their funds and the total funds deposited in the system. The primary operations are <code>deposit</code>, <code>transfer</code>, and <code>withdraw</code>.</p><h1 id="WritingSimpleRules-ABasicRule">A Basic Rule</h1><p>‌Thinking about the function <code>deposit</code>, a basic property is:</p><p><em><strong>P1: Correct deposit functionality: The balance of the beneficiary is increased appropriately</strong></em></p><ol><li><p>Write a rule for checking property P1, &quot;Correct deposit functionality&quot;</p></li><li><p>Is the contract correct with respect to P1?</p></li><li><p>If the contract is incorrect with respect to P1, fix the contract and re-run the Prover.</p></li><li><p>What about the balances of other users? How should it be affected by a deposit? Think about the property, then repeat steps 1-3 for it.</p></li></ol><h1 id="WritingSimpleRules-UsingPreconditionchecksandHelperVariables">Using Precondition checks and Helper Variables</h1><p>‌Let’s define another property and verify that after <code>deposit</code>, the <code>totalFunds</code> in the system is at least the funds of the <code>msg.sender</code>:</p><p>‌<em><strong>P2: Sanity of deposit: total funds &gt;= funds of the single user</strong></em></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">rule totalFundsAfterDeposit(uint256 amount) {
	env e; 
	
	deposit(e, amount);
	
	uint256 userFundsAfter = getFunds(e, e.msg.sender);
	uint256 totalAfter = getTotalFunds(e);
	
	// Verify that the total funds of the system is at least the current funds of the msg.sender.
	assert totalAfter &gt;= userFundsAfter, &quot;Total funds are less than a user&#39;s funds&quot;;
}</pre>
</div></div><ol><li><p>Run the spec on <code>totalFundsAfterDeposit</code> only (hint: use <code>--rule</code>).</p></li><li><p>A violation is found. Do you understand why?</p></li><li><p>Adding additional variables to the rule can help understand the counter-example. Try adding the <em><strong>helper variables</strong></em> <code>userFundsBefore</code> and <code>totalBefore</code>.</p></li><li><p>Add a precondition using <code>require</code> on the initial state before invoking <code>deposit</code>. re-run the tool and make sure that the rule passes. Give your run a distinct name using <code>--msg</code>.</p></li><li><p>Is the requirement you added a realistic one? Or can it be violated in concrete executions of the Bank contract?</p></li></ol><h1 id="WritingSimpleRules-ParametricRules">Parametric Rules</h1><p>This property can be generalized to hold for all functions.</p><p>‌<em><strong>P3: Sanity of total funds: total funds &gt;= funds of a single user</strong></em>‌</p><ol><li><p>Write a rule for checking property P3.</p></li><li><p>Your new rule should run on all public or external methods in the Bank contract. Make sure that you see all function results.</p></li><li><p>Are all functions correct with respect to P3?</p></li><li><p>Re-run the tool on the original version of the Bank contract. What are the results of P3 now?</p></li></ol><p>‌Parametric rules enable expressing reusable and concise correctness conditions. Note that they are not dependent on the implementation. You can integrate them easily into the CI to verify changes to the code, including signature changes, new functions, and implementation changes.</p>
                    </div>

                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Jan 21, 2022 10:00</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
